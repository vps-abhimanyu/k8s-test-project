<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Employee Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    >
</head>

<body class="bg-light">

<div class="container py-4">
    <h1 class="mb-4">Employee Manager</h1>

    <!-- Backend status -->
    <div class="mb-3">
        <button class="btn btn-secondary btn-sm" onclick="checkHealth()">Check Backend Health</button>
        <span id="health-status" class="ms-2 text-success"></span>
    </div>

    <!-- RPS -->
    <div class="mb-3">
        <strong>API Requests Per Second:</strong>
        <span id="rps-value">-</span>
    </div>

    <hr>

    <!-- Add Employee Form -->
    <h3>Add Employee</h3>
    <form id="emp-form" class="row g-3 mb-4" onsubmit="return addEmployee();">

        <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="emp-name" required>
        </div>

        <div class="col-md-4">
            <label class="form-label">Role</label>
            <input type="text" class="form-control" id="emp-role" required>
        </div>

        <div class="col-md-3">
            <label class="form-label">Salary</label>
            <input type="number" step="0.01" class="form-control" id="emp-salary" required>
        </div>

        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add</button>
        </div>

    </form>

    <!-- Employee List -->
    <h3>Employee List</h3>
    <button class="btn btn-outline-primary btn-sm mb-2" onclick="loadEmployees()">Refresh List</button>

    <table class="table table-striped table-sm" id="emp-table">
        <thead>
        <tr>
            <th>ID</th><th>Name</th><th>Role</th><th>Salary</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

</div>

<!-- Inject API_BASE from Flask -->
<script>
    const API_BASE = "{{ api_base }}";
</script>

<script>
    async function checkHealth() {
        try {
            const res = await fetch(`${API_BASE}/health`);
            const data = await res.json();
            document.getElementById("health-status").textContent =
                `Status: ${data.status}`;
        } catch (err) {
            document.getElementById("health-status").textContent =
                "Backend not reachable!";
        }
    }

    async function addEmployee() {
        const name = document.getElementById("emp-name").value;
        const role = document.getElementById("emp-role").value;
        const salary = document.getElementById("emp-salary").value;

        const payload = { name, role, salary: Number(salary) };

        try {
            const res = await fetch(`${API_BASE}/employees`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                alert("Failed to add employee");
                return false;
            }

            document.getElementById("emp-form").reset();
            loadEmployees();
        } catch (err) {
            alert("Backend error");
        }

        return false;
    }

    async function loadEmployees() {
        try {
            const res = await fetch(`${API_BASE}/employees`);
            const list = await res.json();

            const tbody = document.querySelector("#emp-table tbody");
            tbody.innerHTML = "";

            list.forEach(emp => {
                const tr = `
                    <tr>
                        <td>${emp.id}</td>
                        <td>${emp.name}</td>
                        <td>${emp.role}</td>
                        <td>${emp.salary}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        } catch (err) {
            console.error("Error loading employees", err);
        }
    }

    async function updateRps() {
        try {
            const res = await fetch(`${API_BASE}/metrics/rps`);
            const data = await res.json();
            document.getElementById("rps-value").textContent =
                data.requests_per_second.toFixed(2);
        } catch (err) {
            document.getElementById("rps-value").textContent = "-";
        }
    }

    // Initial load
    checkHealth();
    loadEmployees();
    setInterval(updateRps, 1000);  // update every second

</script>

</body>
</html>
