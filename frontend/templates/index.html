<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Employee Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    >
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="mb-4">Employee Manager</h1>

    <!-- Backend Status -->
    <div class="mb-3">
        <button class="btn btn-secondary btn-sm" onclick="checkHealth()">Check Backend Health</button>
        <span id="health-status" class="ms-2 text-success"></span>
    </div>

    <!-- RPS -->
    <div class="mb-3">
        <strong>API Requests Per Second:</strong>
        <span id="rps-value">-</span>
    </div>

    <hr>

    <!-- Add Employee -->
    <h3>Add Employee</h3>
    <form id="emp-form" class="row g-3 mb-4" onsubmit="return addEmployee();">

        <div class="col-md-4">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="emp-name" required>
        </div>

        <div class="col-md-4">
            <label class="form-label">Role</label>
            <input type="text" class="form-control" id="emp-role" required>
        </div>

        <div class="col-md-3">
            <label class="form-label">Salary</label>
            <input type="number" step="0.01" class="form-control" id="emp-salary" required>
        </div>

        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add</button>
        </div>
    </form>

    <!-- Employee List -->
    <h3>Employee List</h3>
    <button class="btn btn-outline-primary btn-sm mb-2" onclick="loadEmployees()">Refresh List</button>

    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>ID</th><th>Name</th><th>Role</th><th>Salary</th>
            </tr>
        </thead>
        <tbody id="emp-table"></tbody>
    </table>
</div>

<script>
    const API_BASE = "http://localhost:8000";

    async function checkHealth() {
        try {
            const res = await fetch(`${API_BASE}/health`);
            const data = await res.json();
            document.getElementById("health-status").textContent =
                `Status: ${data.status}`;
        } catch (err) {
            document.getElementById("health-status").textContent =
                "Backend not reachable!";
        }
    }

    async function addEmployee() {
        const name = document.getElementById("emp-name").value;
        const role = document.getElementById("emp-role").value;
        const salary = document.getElementById("emp-salary").value;

        const payload = { name, role, salary: Number(salary) };

        try {
            const res = await fetch(`${API_BASE}/employees`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                alert("Failed to add employee");
                return false;
            }

            document.getElementById("emp-form").reset();
            loadEmployees();
        } catch (err) {
            alert("Error communicating with backend.");
        }
        return false;
    }

    async function loadEmployees() {
        try {
            const res = await fetch(`${API_BASE}/employees`);
            const list = await res.json();

            const tbody = document.getElementById("emp-table");
            tbody.innerHTML = "";

            list.forEach(emp => {
                const row = `
                    <tr>
                        <td>${emp.id}</td>
                        <td>${emp.name}</td>
                        <td>${emp.role}</td>
                        <td>${emp.salary}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (err) {
            console.error("Could not load employee list", err);
        }
    }

    async function updateRps() {
        try {
            const res = await fetch(`${API_BASE}/metrics/rps`);
            const data = await res.json();
            document.getElementById("rps-value").textContent =
                data.requests_per_second.toFixed(2);
        } catch (err) {
            document.getElementById("rps-value").textContent = "-";
        }
    }

    // Auto-load on page load
    loadEmployees();
    checkHealth();
    setInterval(updateRps, 1000);
</script>

</body>
</html>
